{% extends "base.html" %}

{% block title %}Session Summary - Hypertrophy Toolbox{% endblock %}

{% block page_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/session_summary.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_frames.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="page-header text-center mb-4">
        <h1>Session Summary</h1>
        <div class="header-underline"></div>
    </div>

    <!-- Add base layer frame -->
    <div class="summary-frame">
        <!-- Method Selection and Legend with full width -->
        <div class="summary-header">
            <!-- Calculation Method Toggles -->
            <div class="method-selector">
                <div class="mb-3">
                    <label for="counting-mode" class="form-label">Set Counting Mode</label>
                    <select id="counting-mode" class="form-select" onchange="updateSessionSummary()">
                        <option value="effective" selected>Effective Sets (Effort & Rep Range Weighted)</option>
                        <option value="raw">Raw Sets (Unweighted)</option>
                    </select>
                    <small class="form-text text-muted">
                        <strong>Effective Sets:</strong> Weights sets by effort (RIR/RPE) and rep range to estimate hypertrophy stimulus. Lower RIR = more credit.<br>
                        <strong>Raw Sets:</strong> Simple set count without any adjustments.
                    </small>
                </div>
                <div class="mb-3">
                    <label for="contribution-mode" class="form-label">Muscle Contribution Mode</label>
                    <select id="contribution-mode" class="form-select" onchange="updateSessionSummary()">
                        <option value="total" selected>Total (Primary + Secondary + Tertiary)</option>
                        <option value="direct">Direct Only (Primary Muscle Only)</option>
                    </select>
                    <small class="form-text text-muted">
                        <strong>Total:</strong> Counts volume from all muscles worked (Primary 100%, Secondary 50%, Tertiary 25%).<br>
                        <strong>Direct Only:</strong> Only counts sets where the muscle is the primary target.
                    </small>
                </div>
            </div>

            <!-- Volume Classification Legend -->
            <div class="volume-legend">
                <h5>Volume Classification Legend <small class="text-muted">(Based on Effective Sets)</small></h5>
                <div class="legend-indicators">
                    <div class="legend-item">
                        <div class="volume-indicator low-volume"></div>
                        <span>Low Volume: Below 10 effective sets</span>
                    </div>
                    <div class="legend-item">
                        <div class="volume-indicator medium-volume"></div>
                        <span>Medium Volume: 10-19 effective sets</span>
                    </div>
                    <div class="legend-item">
                        <div class="volume-indicator high-volume"></div>
                        <span>High Volume: 20-29 effective sets</span>
                    </div>
                    <div class="legend-item">
                        <div class="volume-indicator ultra-volume"></div>
                        <span>Excessive Volume: 30+ effective sets</span>
                    </div>
                </div>
                <div class="mt-2 small text-muted">
                    <strong>Session Warnings:</strong> ≤10 OK | 10-11 Borderline | &gt;11 Excessive per muscle
                </div>
            </div>
        </div>

        <!-- Tables in frame -->
        <div class="summary-tables">
            <!-- Existing tables wrapped in sections -->
            <!-- AGENT:START B-4 PRIORITY-CLASSES -->
            <div class="summary-section">
                <div id="session-summary-container" class="table-container">
                    <div class="tbl-wrap tbl-wrap--full" role="region" aria-label="Session summary table">
                        <table class="table table-striped tbl tbl--responsive" 
                               role="table" 
                               aria-label="Session muscle group summary">
                            <thead>
                                <tr>
                                    <th scope="col" class="col--high" data-label="Routine">Routine</th>
                                    <th scope="col" class="col--high" data-label="Muscle Group">Muscle Group</th>
                                    <th scope="col" class="col--high is-num" data-label="Effective Sets">Effective Sets</th>
                                    <th scope="col" class="col--med is-num" data-label="Raw Sets">Raw Sets</th>
                                    <th scope="col" class="col--med is-num" data-label="Total Volume">Total Volume</th>
                                    <th scope="col" class="col--high" data-label="Volume Status">Volume Status</th>
                                </tr>
                            </thead>
                            <tbody id="session-summary-table">
                                <!-- Will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="summary-section">
                <h3 class="text-center mb-4">Exercise Categories Summary</h3>
                <div class="tbl-wrap tbl-wrap--full" role="region" aria-label="Exercise categories table">
                    <table class="table table-striped tbl tbl--responsive" 
                           role="table" 
                           aria-label="Exercise categories">
                        <thead>
                            <tr>
                                <th scope="col" class="col--high" data-label="Category">Category</th>
                                <th scope="col" class="col--high" data-label="Subcategory">Subcategory</th>
                                <th scope="col" class="col--high is-num" data-label="Total Exercises">Total Exercises</th>
                            </tr>
                        </thead>
                        <tbody id="categories-table-body">
                            {% for category in categories %}
                            <tr>
                                <td data-label="Category">
                                    <span data-bs-toggle="tooltip" 
                                          title="{{ get_category_tooltip(category.category) }}">
                                        {{ category.category }}
                                    </span>
                                </td>
                                <td data-label="Subcategory">
                                    <span data-bs-toggle="tooltip" 
                                          title="{{ get_subcategory_tooltip(category.category, category.subcategory) }}">
                                        {{ category.subcategory }}
                                    </span>
                                </td>
                                <td data-label="Total Exercises">{{ category.total_exercises }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="summary-section">
                <h3 class="text-center mb-4">Advanced Isolated Muscles Statistics</h3>
                <div class="tbl-wrap tbl-wrap--full" role="region" aria-label="Isolated muscles statistics table">
                    <table class="table table-striped tbl tbl--responsive" 
                           role="table" 
                           aria-label="Isolated muscles statistics">
                        <thead>
                            <tr>
                                <th scope="col" class="col--high" data-label="Isolated Muscle">Isolated Muscle</th>
                                <th scope="col" class="col--med is-num" data-label="Exercise Count">Exercise Count</th>
                                <th scope="col" class="col--high is-num" data-label="Total Sets">Total Sets</th>
                                <th scope="col" class="col--med is-num" data-label="Total Reps">Total Reps</th>
                                <th scope="col" class="col--med is-num" data-label="Total Volume">Total Volume</th>
                                <th scope="col" class="col--high" data-label="Volume Classification">Volume Classification</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for muscle in isolated_muscles %}
                            <tr>
                                <td data-label="Isolated Muscle">{{ muscle.isolated_muscle }}</td>
                                <td data-label="Exercise Count">{{ muscle.exercise_count }}</td>
                                <td data-label="Total Sets">{{ muscle.total_sets }}</td>
                                <td data-label="Total Reps">{{ muscle.total_reps }}</td>
                                <td data-label="Total Volume">{{ muscle.total_volume }}</td>
                                <td data-label="Volume Classification">
                                    <div class="volume-classification" 
                                         data-bs-toggle="tooltip"
                                         title="{{ get_volume_tooltip(get_volume_label(muscle.total_sets), muscle.total_sets) }}">
                                        <span class="volume-badge {{ get_volume_class(muscle.total_sets) }}">
                                            {{ get_volume_label(muscle.total_sets) }}
                                        </span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- AGENT:END B-4 PRIORITY-CLASSES -->
        </div>

        <!-- Volume Formula Explanation -->
        <div class="alert alert-info mt-4 mb-4">
            <strong>Training Volume Formula:</strong> Total Volume = Sets × Reps × Weight
        </div>

        <!-- Export Button -->
        <div class="export-section mt-3 text-center">
            <button type="button" class="btn btn-export-excel" onclick="exportToExcel()" aria-label="Export session summary to Excel">
                <i class="fas fa-file-excel"></i> Export All Tables
            </button>
        </div>
    </div>
</div>

<script>
// Add tooltip functions
function get_category_tooltip(category) {
    const tooltips = {
        'Mechanic': 'Classification based on joint involvement in the exercise',
        'Utility': 'Classification based on exercise role in training',
        'Force': 'Classification based on primary force direction'
    };
    return tooltips[category] || '';
}

function get_subcategory_tooltip(category, subcategory) {
    const tooltips = {
        'Mechanic': {
            'Compound': 'Multi-joint exercises like squats and bench press',
            'Isolated': 'Single-joint exercises focusing on specific muscles'
        },
        'Utility': {
            'Auxiliary': 'Supportive exercises that complement main lifts',
            'Basic': 'Foundational exercises targeting major muscle groups'
        },
        'Force': {
            'Push': 'Exercises involving pushing motions away from body',
            'Pull': 'Exercises involving pulling motions toward body'
        }
    };
    return tooltips[category]?.[subcategory] || '';
}

// Function to get volume classification details based on effective sets
function getVolumeDetails(effectiveSets) {
    let volumeClass, volumeLabel;
    
    if (effectiveSets < 10) {
        volumeClass = 'low-volume';
        volumeLabel = 'Low Volume';
    } else if (effectiveSets < 20) {
        volumeClass = 'medium-volume';
        volumeLabel = 'Medium Volume';
    } else if (effectiveSets < 30) {
        volumeClass = 'high-volume';
        volumeLabel = 'High Volume';
    } else {
        volumeClass = 'ultra-volume';
        volumeLabel = 'Excessive Volume';
    }

    const ranges = {
        'Low Volume': 'Below 10 effective sets',
        'Medium Volume': '10-19 effective sets',
        'High Volume': '20-29 effective sets',
        'Excessive Volume': '30+ effective sets'
    };

    return {
        class: volumeClass,
        label: volumeLabel,
        tooltip: `${volumeLabel}: ${ranges[volumeLabel]} (Current: ${effectiveSets.toFixed(1)} effective sets)`
    };
}

// Function to get session warning badge
function getSessionWarningBadge(warningLevel, effectivePerSession) {
    const warnings = {
        'ok': { class: 'bg-success', label: 'OK', tooltip: 'Session volume within productive limits' },
        'borderline': { class: 'bg-warning text-dark', label: 'Borderline', tooltip: 'Approaching productive limits' },
        'excessive': { class: 'bg-danger', label: 'Excessive', tooltip: 'May exceed productive stimulus' }
    };
    const warning = warnings[warningLevel] || warnings['ok'];
    return {
        ...warning,
        tooltip: `${warning.tooltip} (${effectivePerSession.toFixed(1)} effective sets/session)`
    };
}

// Function to update the session summary table based on the selected modes
async function updateSessionSummary() {
    const countingMode = document.getElementById("counting-mode").value;
    const contributionMode = document.getElementById("contribution-mode").value;
    const tableBody = document.getElementById("session-summary-table");
    const categoryTableBody = document.getElementById("categories-table-body");

    // Display loading spinner
    tableBody.innerHTML = `
        <tr>
            <td colspan="6" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </td>
        </tr>`;

    try {
        const response = await fetch(`/session_summary?counting_mode=${countingMode}&contribution_mode=${contributionMode}`, {
            headers: { "Accept": "application/json" }
        });

        if (!response.ok) throw new Error("Failed to fetch session summary.");

        const data = await response.json();

        if (data.session_summary.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">No data available.</td>
                </tr>`;
        } else {
            // Populate the table with fetched data
            tableBody.innerHTML = data.session_summary.map(row => {
                const effectiveSets = row.effective_sets || row.total_sets;
                const rawSets = row.raw_sets || row.total_sets;
                const effectivePerSession = row.effective_per_session || effectiveSets;
                const warningLevel = row.warning_level || 'ok';
                const volume = getVolumeDetails(effectiveSets);
                const warning = getSessionWarningBadge(warningLevel, effectivePerSession);
                
                return `
                    <tr class="${row.is_excessive ? 'table-danger' : row.is_borderline ? 'table-warning' : ''}">
                        <td data-label="Routine">${row.routine || "N/A"}</td>
                        <td data-label="Muscle Group">${row.muscle_group || "N/A"}</td>
                        <td data-label="Effective Sets" class="is-num">${effectiveSets.toFixed(1)}</td>
                        <td data-label="Raw Sets" class="is-num">${rawSets.toFixed(1)}</td>
                        <td data-label="Total Volume" class="is-num">${(row.total_volume || 0).toFixed(0)}</td>
                        <td data-label="Volume Status">
                            <div class="d-flex flex-column gap-1">
                                <div class="volume-classification" 
                                     data-bs-toggle="tooltip"
                                     title="${volume.tooltip}">
                                    <span class="volume-badge ${volume.class}">
                                        ${volume.label}
                                    </span>
                                </div>
                                <span class="badge ${warning.class}" 
                                      data-bs-toggle="tooltip"
                                      title="${warning.tooltip}">
                                    ${warning.label}
                                </span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join("");
        }

        // Update categories table
        if (data.categories.length === 0) {
            categoryTableBody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-muted">No categories data available.</td>
                </tr>`;
        } else {
            categoryTableBody.innerHTML = data.categories.map(cat => `
                <tr>
                    <td>
                        <span data-bs-toggle="tooltip" 
                              title="${get_category_tooltip(cat.category)}">
                            ${cat.category}
                        </span>
                    </td>
                    <td>
                        <span data-bs-toggle="tooltip" 
                              title="${get_subcategory_tooltip(cat.category, cat.subcategory)}">
                            ${cat.subcategory}
                        </span>
                    </td>
                    <td>${cat.total_exercises}</td>
                </tr>
            `).join('');
        }

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

    } catch (error) {
        console.error("Error fetching data:", error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-danger">Failed to load data.</td>
            </tr>`;
    }
}

// Initialize table when the page loads
document.addEventListener("DOMContentLoaded", updateSessionSummary);
</script>
{% endblock %}
