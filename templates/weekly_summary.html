{% extends "base.html" %}

{% block title %}Weekly Summary - Hypertrophy Toolbox{% endblock %}

{% block page_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/session_summary.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_volume.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_frames.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_muscle_groups.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="page-header text-center">
        <h1>Weekly Summary</h1>
        <div class="header-underline"></div>
    </div>

    <!-- Add base layer frame -->
    <div class="summary-frame">
        <!-- Method Selection and Legend with full width -->
        <div class="summary-header">
            <!-- Calculation Method Toggles -->
            <div class="method-selector">
                <div class="mb-3">
                    <label for="counting-mode" class="form-label">Set Counting Mode</label>
                    <select id="counting-mode" class="form-select" onchange="updateWeeklySummary()">
                        <option value="effective" selected>Effective Sets (Effort & Rep Range Weighted)</option>
                        <option value="raw">Raw Sets (Unweighted)</option>
                    </select>
                    <small class="form-text text-muted">
                        <strong>Effective Sets:</strong> Weights sets by effort (RIR/RPE) and rep range to estimate hypertrophy stimulus. Lower RIR = more credit.<br>
                        <strong>Raw Sets:</strong> Simple set count without any adjustments.
                    </small>
                </div>
                <div class="mb-3">
                    <label for="contribution-mode" class="form-label">Muscle Contribution Mode</label>
                    <select id="contribution-mode" class="form-select" onchange="updateWeeklySummary()">
                        <option value="total" selected>Total (Primary + Secondary + Tertiary)</option>
                        <option value="direct">Direct Only (Primary Muscle Only)</option>
                    </select>
                    <small class="form-text text-muted">
                        <strong>Total:</strong> Counts volume from all muscles worked (Primary 100%, Secondary 50%, Tertiary 25%).<br>
                        <strong>Direct Only:</strong> Only counts sets where the muscle is the primary target.
                    </small>
                </div>
            </div>

            <!-- Volume Classification Legend -->
            <div class="volume-legend">
                <h5>Volume Classification Legend <small class="text-muted">(Based on Effective Sets)</small></h5>
                <div class="legend-indicators">
                    <div class="legend-item">
                        <div class="volume-indicator low-volume"></div>
                        <span>Low Volume: Below 10 effective sets</span>
                    </div>
                    <div class="legend-item">
                        <div class="volume-indicator medium-volume"></div>
                        <span>Medium Volume: 10-19 effective sets</span>
                    </div>
                    <div class="legend-item">
                        <div class="volume-indicator high-volume"></div>
                        <span>High Volume: 20-29 effective sets</span>
                    </div>
                    <div class="legend-item">
                        <div class="volume-indicator ultra-volume"></div>
                        <span>Excessive Volume: 30+ effective sets</span>
                    </div>
                </div>
                <div class="mt-2 small text-muted">
                    <strong>Effective Sets</strong> = Raw Sets × Effort Factor (RIR/RPE) × Rep Range Factor
                </div>
            </div>
        </div>

        <!-- Tables in frame -->
        <div class="summary-tables">
            <!-- Weekly Summary Table -->
            <!-- AGENT:START B-3 PRIORITY-CLASSES -->
            <div class="summary-section">
                <div id="weekly-summary-container" class="table-container">
                    <div class="tbl-wrap tbl-wrap--full" role="region" aria-label="Weekly summary table">
                        <table class="table table-striped tbl tbl--responsive" 
                               role="table" 
                               aria-label="Weekly muscle group summary">
                            <thead>
                                <tr>
                                    <th scope="col" class="col--high" data-label="Muscle Group">Muscle Group</th>
                                    <th scope="col" class="col--high is-num" data-label="Effective Sets">Effective Sets</th>
                                    <th scope="col" class="col--med is-num" data-label="Raw Sets">Raw Sets</th>
                                    <th scope="col" class="col--med is-num" data-label="Frequency">Frequency</th>
                                    <th scope="col" class="col--med is-num" data-label="Total Volume">Total Volume</th>
                                    <th scope="col" class="col--high" data-label="Volume Classification">Volume Classification</th>
                                </tr>
                            </thead>
                            <tbody id="weekly-summary-table">
                                <!-- Will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Exercise Categories Summary -->
            <div class="summary-section">
                <h3 class="text-center">Exercise Categories Summary</h3>
                <div class="tbl-wrap tbl-wrap--full" role="region" aria-label="Exercise categories table">
                    <table class="table table-striped tbl tbl--responsive" 
                           role="table" 
                           aria-label="Exercise categories">
                        <thead>
                            <tr>
                                <th scope="col" class="col--high" data-label="Category">Category</th>
                                <th scope="col" class="col--high" data-label="Subcategory">Subcategory</th>
                                <th scope="col" class="col--high is-num" data-label="Total Exercises">Total Exercises</th>
                            </tr>
                        </thead>
                        <tbody id="categories-table-body">
                            {% for category in categories %}
                            <tr>
                                <td data-label="Category">
                                    <span data-bs-toggle="tooltip" 
                                          title="{{ get_category_tooltip(category.category) }}">
                                        {{ category.category }}
                                    </span>
                                </td>
                                <td data-label="Subcategory">
                                    <span data-bs-toggle="tooltip" 
                                          title="{{ get_subcategory_tooltip(category.category, category.subcategory) }}">
                                        {{ category.subcategory }}
                                    </span>
                                </td>
                                <td data-label="Total Exercises">{{ category.total_exercises }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Advanced Isolated Muscles Statistics -->
            <div class="summary-section">
                <h3 class="text-center">Advanced Isolated Muscles Statistics</h3>
                <div class="tbl-wrap tbl-wrap--full" role="region" aria-label="Isolated muscles statistics table">
                    <table class="table table-striped tbl tbl--responsive" 
                           role="table" 
                           aria-label="Isolated muscles statistics">
                        <thead>
                            <tr>
                                <th scope="col" class="col--high" data-label="Isolated Muscle">Isolated Muscle</th>
                                <th scope="col" class="col--med is-num" data-label="Exercise Count">Exercise Count</th>
                                <th scope="col" class="col--high is-num" data-label="Total Sets">Total Sets</th>
                                <th scope="col" class="col--med is-num" data-label="Total Reps">Total Reps</th>
                                <th scope="col" class="col--med is-num" data-label="Total Volume">Total Volume</th>
                                <th scope="col" class="col--high" data-label="Volume Classification">Volume Classification</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for muscle in isolated_muscles %}
                            <tr>
                                <td data-label="Isolated Muscle">{{ muscle.isolated_muscle }}</td>
                                <td data-label="Exercise Count">{{ muscle.exercise_count }}</td>
                                <td data-label="Total Sets">{{ muscle.total_sets }}</td>
                                <td data-label="Total Reps">{{ muscle.total_reps }}</td>
                                <td data-label="Total Volume">{{ muscle.total_volume }}</td>
                                <td data-label="Volume Classification">
                                    <div class="volume-classification" 
                                         data-bs-toggle="tooltip"
                                         title="{{ get_volume_tooltip(get_volume_label(muscle.total_sets), muscle.total_sets) }}">
                                        <span class="volume-badge {{ get_volume_class(muscle.total_sets) }}">
                                            {{ get_volume_label(muscle.total_sets) }}
                                        </span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- AGENT:END B-3 PRIORITY-CLASSES -->
        </div>

        <!-- Movement Pattern Coverage Section -->
        <div class="summary-section mt-4" id="pattern-coverage-section">
            <h3 class="text-center">
                <i class="fas fa-project-diagram me-2"></i>Movement Pattern Coverage
            </h3>
            <div id="pattern-coverage-container">
                <!-- Will be populated dynamically -->
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Volume Formula Explanation -->
        <div class="alert alert-info mt-4 mb-4">
            <strong>Training Volume Formula:</strong> Total Volume = Sets × Reps × Weight
        </div>

        <!-- Export Button -->
        <div class="export-section mt-3 text-center">
            <button type="button" class="btn btn-export-excel" onclick="exportToExcel()" aria-label="Export weekly summary to Excel">
                <i class="fas fa-file-excel"></i> Export All Tables
            </button>
        </div>
    </div>
</div>

<script>
// Function to get volume classification details based on effective sets
function getVolumeDetails(effectiveSets) {
    let volumeClass, volumeLabel;
    
    if (effectiveSets < 10) {
        volumeClass = 'low-volume';
        volumeLabel = 'Low Volume';
    } else if (effectiveSets < 20) {
        volumeClass = 'medium-volume';
        volumeLabel = 'Medium Volume';
    } else if (effectiveSets < 30) {
        volumeClass = 'high-volume';
        volumeLabel = 'High Volume';
    } else {
        volumeClass = 'ultra-volume';
        volumeLabel = 'Excessive Volume';
    }

    const ranges = {
        'Low Volume': 'Below 10 effective sets',
        'Medium Volume': '10-19 effective sets',
        'High Volume': '20-29 effective sets',
        'Excessive Volume': '30+ effective sets'
    };

    return {
        class: volumeClass,
        label: volumeLabel,
        tooltip: `${volumeLabel}: ${ranges[volumeLabel]} (Current: ${effectiveSets.toFixed(1)} effective sets)`
    };
}

// Pattern name formatting
function formatPatternName(pattern) {
    const nameMap = {
        'squat': 'Squat',
        'hinge': 'Hinge',
        'horizontal_push': 'Horizontal Push',
        'horizontal_pull': 'Horizontal Pull',
        'vertical_push': 'Vertical Push',
        'vertical_pull': 'Vertical Pull',
        'core_static': 'Core (Static)',
        'core_dynamic': 'Core (Dynamic)',
        'upper_isolation': 'Upper Isolation',
        'lower_isolation': 'Lower Isolation',
        'other': 'Other'
    };
    return nameMap[pattern] || pattern.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

// Function to fetch and display pattern coverage
async function updatePatternCoverage() {
    const container = document.getElementById('pattern-coverage-container');
    
    try {
        const response = await fetch('/api/pattern_coverage');
        if (!response.ok) throw new Error('Failed to fetch pattern coverage');
        
        const result = await response.json();
        if (!result.success || !result.data) throw new Error('Invalid response');
        
        const data = result.data;
        const hasData = Object.keys(data.total || {}).length > 0;
        
        if (!hasData) {
            container.innerHTML = `
                <div class="alert alert-secondary text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    No exercises in your workout plan yet. Add exercises to see pattern coverage analysis.
                </div>`;
            return;
        }
        
        // Build the pattern coverage display
        let html = '';
        
        // Warnings section
        if (data.warnings && data.warnings.length > 0) {
            html += `<div class="mb-4">`;
            data.warnings.forEach(warning => {
                const alertClass = warning.level === 'high' ? 'danger' : 
                                   warning.level === 'medium' ? 'warning' : 'info';
                const icon = warning.level === 'high' ? 'exclamation-circle' : 
                             warning.level === 'medium' ? 'exclamation-triangle' : 'info-circle';
                html += `
                    <div class="alert alert-${alertClass} d-flex align-items-start mb-2">
                        <i class="fas fa-${icon} me-2 mt-1"></i>
                        <div>
                            <strong>${warning.message}</strong><br>
                            <small>${warning.description}</small>
                        </div>
                    </div>`;
            });
            html += `</div>`;
        }
        
        // Total pattern coverage
        html += `
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <h5 class="mb-3">Total Sets by Movement Pattern</h5>
                    <div class="d-flex flex-wrap gap-2">`;
        
        // Core patterns first, then others
        const corePatterns = ['squat', 'hinge', 'horizontal_push', 'horizontal_pull', 'vertical_push', 'vertical_pull'];
        const otherPatterns = Object.keys(data.total).filter(p => !corePatterns.includes(p));
        const allPatterns = [...corePatterns, ...otherPatterns];
        
        allPatterns.forEach(pattern => {
            const sets = data.total[pattern] || 0;
            if (sets > 0 || corePatterns.includes(pattern)) {
                const isCore = corePatterns.includes(pattern);
                const btnClass = sets === 0 ? 'outline-danger' : 
                                 sets < 3 ? 'outline-warning' : 'outline-success';
                html += `
                    <span class="badge bg-${btnClass} text-dark border" style="font-size: 0.9rem; padding: 8px 12px;">
                        ${isCore ? '<i class="fas fa-check-circle me-1"></i>' : ''}
                        ${formatPatternName(pattern)}: <strong>${sets}</strong>
                    </span>`;
            }
        });
        
        html += `</div></div></div>`;
        
        // Sets per routine
        if (Object.keys(data.sets_per_routine || {}).length > 0) {
            html += `
                <div class="row g-3">
                    <div class="col-12">
                        <h5 class="mb-3">Sets per Routine</h5>
                        <div class="d-flex flex-wrap gap-3">`;
            
            const idealMin = data.ideal_sets_range?.min || 15;
            const idealMax = data.ideal_sets_range?.max || 24;
            
            Object.entries(data.sets_per_routine).forEach(([routine, sets]) => {
                const status = sets < idealMin ? 'warning' : 
                               sets > idealMax ? 'danger' : 'success';
                const icon = sets < idealMin ? 'arrow-down' : 
                             sets > idealMax ? 'arrow-up' : 'check';
                html += `
                    <div class="card border-${status}" style="min-width: 150px;">
                        <div class="card-body text-center py-2">
                            <h6 class="card-title mb-1">Routine ${routine}</h6>
                            <p class="card-text mb-0">
                                <span class="text-${status}">
                                    <i class="fas fa-${icon} me-1"></i>
                                    <strong>${sets}</strong> sets
                                </span>
                            </p>
                            <small class="text-muted">Target: ${idealMin}-${idealMax}</small>
                        </div>
                    </div>`;
            });
            
            html += `</div></div></div>`;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error fetching pattern coverage:', error);
        container.innerHTML = `
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Unable to load pattern coverage analysis.
            </div>`;
    }
}

// Function to update the weekly summary table based on the selected modes
async function updateWeeklySummary() {
    const countingMode = document.getElementById("counting-mode").value;
    const contributionMode = document.getElementById("contribution-mode").value;
    const tableBody = document.getElementById("weekly-summary-table");
    const categoryTableBody = document.getElementById("categories-table-body");

    // Display loading spinner
    tableBody.innerHTML = `
        <tr>
            <td colspan="6" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </td>
        </tr>`;

    try {
        const response = await fetch(`/weekly_summary?counting_mode=${countingMode}&contribution_mode=${contributionMode}`, {
            headers: { "Accept": "application/json" }
        });

        if (!response.ok) throw new Error("Failed to fetch weekly summary.");

        const data = await response.json();

        // Update weekly summary table
        if (data.weekly_summary.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">No data available.</td>
                </tr>`;
        } else {
            // Populate the table with fetched data
            tableBody.innerHTML = data.weekly_summary.map(row => {
                const effectiveSets = row.effective_sets || row.total_sets;
                const rawSets = row.raw_sets || row.total_sets;
                const frequency = row.frequency || 0;
                const volume = getVolumeDetails(effectiveSets);
                return `
                    <tr>
                        <td data-label="Muscle Group">${row.muscle_group || "N/A"}</td>
                        <td data-label="Effective Sets" class="is-num">${effectiveSets.toFixed(1)}</td>
                        <td data-label="Raw Sets" class="is-num">${rawSets.toFixed(1)}</td>
                        <td data-label="Frequency" class="is-num">${frequency}</td>
                        <td data-label="Total Volume" class="is-num">${(row.total_volume || row.total_weight || 0).toFixed(0)}</td>
                        <td data-label="Volume Classification">
                            <div class="volume-classification" 
                                 data-bs-toggle="tooltip"
                                 title="${volume.tooltip}">
                                <span class="volume-badge ${volume.class}">
                                    ${volume.label}
                                </span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join("");
        }

        // Update categories table
        if (data.categories.length === 0) {
            categoryTableBody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-muted">No categories data available.</td>
                </tr>`;
        } else {
            categoryTableBody.innerHTML = data.categories.map(cat => `
                <tr>
                    <td>
                        <span data-bs-toggle="tooltip" 
                              title="${get_category_tooltip(cat.category)}">
                            ${cat.category}
                        </span>
                    </td>
                    <td>
                        <span data-bs-toggle="tooltip" 
                              title="${get_subcategory_tooltip(cat.category, cat.subcategory)}">
                            ${cat.subcategory}
                        </span>
                    </td>
                    <td>${cat.total_exercises}</td>
                </tr>
            `).join('');
        }

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

    } catch (error) {
        console.error("Error fetching data:", error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-danger">Failed to load data.</td>
            </tr>`;
    }
}

// Initialize table when the page loads
document.addEventListener("DOMContentLoaded", function() {
    updateWeeklySummary();
    updatePatternCoverage();
});

function get_category_tooltip(category) {
    const tooltips = {
        'Mechanic': 'Classification based on joint involvement in the exercise',
        'Utility': 'Classification based on exercise role in training',
        'Force': 'Classification based on primary force direction'
    };
    return tooltips[category] || '';
}

function get_subcategory_tooltip(category, subcategory) {
    const tooltips = {
        'Mechanic': {
            'Compound': 'Multi-joint exercises like squats and bench press',
            'Isolated': 'Single-joint exercises focusing on specific muscles'
        },
        'Utility': {
            'Auxiliary': 'Supportive exercises that complement main lifts',
            'Basic': 'Foundational exercises targeting major muscle groups'
        },
        'Force': {
            'Push': 'Exercises involving pushing motions away from body',
            'Pull': 'Exercises involving pulling motions toward body'
        }
    };
    return tooltips[category]?.[subcategory] || '';
}
</script>
{% endblock %}
