{% extends "base.html" %}

{% block title %}Workout Plan - Hypertrophy Toolbox{% endblock %}

{% block page_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_filters.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_dropdowns.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_workout_dropdowns.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_workout_plan.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_frames.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_routine_cascade.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_muscle_selector.css') }}">
{% endblock %}

{% block content %}
<main id="workout" data-page="workout-plan" role="main">
    <div class="container-fluid">
        <!-- Page Header with consistent styling -->
        <header class="table-header text-center mb-4">
            <h1>Workout Plan</h1>
            <div class="table-header-underline" aria-hidden="true"></div>
        </header>

        <!-- Filters for Exercises -->
        <div class="unified-frames-container">
            <!-- Filters Section -->
            <div class="collapsible-frame filters-section" data-section="filters">
                <div class="frame-header frame-header-2025">
                    <div class="frame-header-left">
                        <span class="filters-title">Filter Exercises</span>
                    </div>
                    <div class="frame-header-right">
                        <button class="collapse-toggle" type="button" title="Collapse filters" aria-expanded="true" aria-controls="filters-content">
                            <i class="fas fa-chevron-up toggle-icon" aria-hidden="true"></i>
                            <span class="toggle-text">Hide</span>
                        </button>
                    </div>
                </div>
                <div class="frame-content" id="filters-content">
                    <div class="filters dropdown-group">
                        <form id="filters-form" class="row gx-4 gy-3" role="search" aria-label="Filter workout plan exercises">
                            {% for filter_name, filter_options in filters.items() %}
                            {% set filter_id = filter_name | lower | replace(' ', '_') %}
                            <div class="col-lg-3 col-md-4 col-sm-6">
                                <label for="{{ filter_id }}" class="form-label">{{ filter_name }}</label>
                                <select id="{{ filter_id }}" name="{{ filter_id }}" data-filter-key="{{ filter_name }}" class="form-select uniform-dropdown filter-dropdown" aria-label="{{ filter_name }} filter">
                                    <option value="">All</option>
                                    {% for option in filter_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endfor %}
                        </form>
                    </div>
                </div>
        </div>

        <!-- Workout Controls Section -->
        <div class="collapsible-frame action-frame" data-section="controls">
            <div class="frame-header frame-header-2025">
                <div class="frame-header-left">
                    <span class="frame-title">Workout Controls</span>
                </div>
                <div class="frame-header-right">
                    <button class="collapse-toggle" type="button" title="Collapse workout controls" aria-expanded="true" aria-controls="controls-content">
                        <i class="fas fa-chevron-up toggle-icon" aria-hidden="true"></i>
                        <span class="toggle-text">Hide</span>
                    </button>
                </div>
            </div>
            <div class="frame-content" id="controls-content">
                <div class="horizontal-layout">
                    <!-- Input Fields Group -->
                    <div class="input-fields-group" role="group" aria-label="Exercise parameters">
                        <div class="input-group">
                            <label for="weight" class="form-label">Weight</label>
                            <input type="number" id="weight" name="weight" class="form-control" min="0" value="25" aria-label="Weight in kilograms">
                        </div>
                        <div class="input-group">
                            <label for="sets" class="form-label">Sets</label>
                            <input type="number" id="sets" name="sets" class="form-control" min="1" value="3" aria-label="Number of sets">
                        </div>
                        <div class="input-group">
                            <label for="rir" class="form-label">RIR</label>
                            <input type="number" id="rir" name="rir" class="form-control" placeholder="RIR" min="0" max="10" value="3" aria-label="Reps in Reserve">
                        </div>
                        <div class="input-group">
                            <label for="rpe" class="form-label">RPE</label>
                            <input type="number" id="rpe" name="rpe" class="form-control" placeholder="RPE" min="1" max="10" step="0.5" value="7" aria-label="Rate of Perceived Exertion">
                        </div>
                        <div class="input-group">
                            <label for="min_rep" class="form-label">Min Rep</label>
                            <input type="number" id="min_rep" name="min_rep" class="form-control" placeholder="Min Rep" min="1" value="6" aria-label="Minimum repetitions">
                        </div>
                        <div class="input-group">
                            <label for="max_rep_range" class="form-label">Max Rep</label>
                            <input type="number" id="max_rep_range" name="max_rep_range" class="form-control" min="1" value="8" aria-label="Maximum repetitions">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exercise Selection Section -->
        <div id="exercise-selection-frame" class="collapsible-frame action-frame" data-section="exercise selection">
            <div class="frame-header frame-header-2025">
                <div class="frame-header-left">
                    <span class="frame-title">Exercise Selection</span>
                </div>
                <div class="frame-header-right">
                    <button class="collapse-toggle" type="button" title="Collapse exercise selection" aria-expanded="true" aria-controls="exercise-selection-content">
                        <i class="fas fa-chevron-up toggle-icon" aria-hidden="true"></i>
                        <span class="toggle-text">Hide</span>
                    </button>
                </div>
            </div>
            <div class="frame-content" id="exercise-selection-content">
                <div class="exercise-selection-grid row gx-4 gy-3 align-items-end" role="group" aria-label="Exercise selection controls">
                    <!-- Cascading Routine Selector -->
                    <div class="col-12 routine-selector selection-field">
                        <label class="form-label">Routine</label>
                        
                        <!-- Hidden field to store composite routine value for form submission -->
                        <input type="hidden" id="routine" name="routine" value="">
                        
                        <div id="routine-cascade-container" class="routine-cascade-container">
                            <!-- Row of 3 cascading dropdowns -->
                            <div class="cascade-row">
                                <!-- Step 1: Environment -->
                                <div class="cascade-dropdown-wrapper">
                                    <label for="routine-env" data-step="1">Environment</label>
                                    <select id="routine-env" name="routine-env" 
                                            data-testid="routine-env"
                                            class="form-select cascade-dropdown cascade-env" 
                                            aria-label="Select environment">
                                        <option value="">Select Environment</option>
                                        <option value="GYM">üèãÔ∏è GYM</option>
                                        <option value="Home Workout">üè† Home Workout</option>
                                    </select>
                                </div>
                                
                                <!-- Connector Arrow 1 -->
                                <div class="cascade-connector cascade-connector-1" aria-hidden="true">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                                
                                <!-- Step 2: Program -->
                                <div class="cascade-dropdown-wrapper">
                                    <label for="routine-program" data-step="2">Program</label>
                                    <select id="routine-program" name="routine-program" 
                                            data-testid="routine-program"
                                            class="form-select cascade-dropdown cascade-program" 
                                            aria-label="Select program" disabled>
                                        <option value="">Select Program</option>
                                    </select>
                                </div>
                                
                                <!-- Connector Arrow 2 -->
                                <div class="cascade-connector cascade-connector-2" aria-hidden="true">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                                
                                <!-- Step 3: Workout Day -->
                                <div class="cascade-dropdown-wrapper">
                                    <label for="routine-day" data-step="3">Workout</label>
                                    <select id="routine-day" name="routine-day" 
                                            data-testid="routine-day"
                                            class="form-select cascade-dropdown cascade-routine" 
                                            aria-label="Select workout day" disabled>
                                        <option value="">Select Workout</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Selection Breadcrumb -->
                            <div id="routine-breadcrumb" class="routine-breadcrumb" aria-live="polite">
                                <span class="breadcrumb-placeholder">Select environment to begin</span>
                            </div>
                        </div>
                    </div>

                    <!-- Exercise Dropdown -->
                    <div class="col-12 exercise-selector selection-field">
                        <label for="exercise" class="form-label">Exercise</label>
                        <select id="exercise" name="exercise" data-testid="exercise-search" class="form-select uniform-dropdown exercise-dropdown" aria-label="Select exercise">
                            {% for exercise in exercises %}
                            {% if exercise %}
                            <option value="{{ exercise }}">{{ exercise }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Action Buttons -->
                    <div class="col-12">
                        <div class="selection-actions buttons-row" id="action-buttons-row" role="group" aria-label="Exercise selection actions">
                            <!-- Add Exercise Button -->
                            <div class="inline-control-item" data-order="3">
                                <button id="add_exercise_btn" data-testid="add-exercise-btn" class="btn btn-primary" type="button" aria-label="Add exercise to workout plan">
                                    <i class="fas fa-plus" aria-hidden="true"></i> Add Exercise
                                </button>
                            </div>

                            <!-- Clear Filters Button -->
                            <div class="inline-control-item" data-order="4">
                                <button id="clear-filters-btn" data-testid="clear-filters-btn" class="btn btn-outline-secondary" type="button" aria-label="Clear all filters">
                                    <i class="fas fa-times" aria-hidden="true"></i> Clear Filters
                                </button>
                            </div>

                            <!-- Export All Tables Button -->
                            <div class="inline-control-item" data-order="5">
                                <button type="button" data-testid="export-excel-btn" class="btn btn-export-excel" onclick="exportToExcel()" aria-label="Export workout plan to Excel">
                                    <i class="fas fa-file-excel" aria-hidden="true"></i> Export All Tables
                                </button>
                            </div>

                            <!-- Export to Workout Log Button -->
                            <div class="inline-control-item" data-order="6">
                                <button id="export-to-log-btn" data-testid="export-to-log-btn" class="btn btn-export-log" type="button" onclick="exportToWorkoutLog()" aria-label="Export to workout log">
                                    <i class="fas fa-clipboard-list" aria-hidden="true"></i> Export to Workout Log
                                </button>
                            </div>

                            <!-- Generate Starter Plan Button -->
                            <div class="inline-control-item" data-order="7">
                                <button id="generate-plan-btn" class="btn btn-success" type="button" data-bs-toggle="modal" data-bs-target="#generatePlanModal" aria-label="Generate a starter workout plan">
                                    <i class="fas fa-magic" aria-hidden="true"></i> Generate Starter Plan
                                </button>
                            </div>
                            
                            <!-- Program Library Buttons -->
                            <div class="inline-control-item" data-order="8">
                                <button id="save-program-btn" class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#saveBackupModal" aria-label="Save current program">
                                    <i class="fas fa-save" aria-hidden="true"></i> Save Program
                                </button>
                            </div>
                            
                            <div class="inline-control-item" data-order="9">
                                <button id="load-program-btn" class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#programLibraryModal" aria-label="Load saved program">
                                    <i class="fas fa-folder-open" aria-hidden="true"></i> Program Library
                                </button>
                            </div>
                            
                            <!-- Clear Plan Button -->
                            <div class="inline-control-item" data-order="10">
                                <button id="clear-plan-btn" class="btn btn-outline-danger" type="button" data-bs-toggle="modal" data-bs-target="#clearPlanModal" aria-label="Clear entire workout plan">
                                    <i class="fas fa-trash-alt" aria-hidden="true"></i> Clear Plan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Display the Workout Plan -->
        <!-- AGENT:START B-1 PRIORITY-CLASSES -->
        <section class="workout-plan table-container mt-5" aria-labelledby="workout-plan-table-heading">
            <div class="table-header">
                <h2 id="workout-plan-table-heading" class="text-center">Workout Plan Table</h2>
                <div class="table-header-underline" aria-hidden="true"></div>
            </div>
            
            <!-- Routine Tabs Navigation -->
            <nav class="routine-tabs-container" aria-label="Filter workout plan by routine">
                <ul class="routine-tabs" id="routine-tabs" role="tablist">
                    <li class="routine-tab active" role="presentation">
                        <button class="routine-tab-btn active" 
                                data-routine="all" 
                                role="tab" 
                                aria-selected="true"
                                aria-controls="workout_plan_table_body"
                                id="tab-all">
                            <span class="tab-label">All</span>
                            <span class="tab-count" id="tab-count-all"></span>
                        </button>
                    </li>
                    <!-- Dynamic routine tabs will be inserted here by JavaScript -->
                </ul>
            </nav>
            
            <!-- Superset Action Buttons (shown when exercises are selected) -->
            <div id="superset-actions" class="superset-actions" style="display: none;">
                <button id="link-superset-btn" class="btn btn-link-superset" type="button" disabled>
                    <i class="fas fa-link" aria-hidden="true"></i> Link as Superset
                </button>
                <button id="unlink-superset-btn" class="btn btn-unlink-superset" type="button" style="display: none;">
                    <i class="fas fa-unlink" aria-hidden="true"></i> Unlink Superset
                </button>
                <span id="superset-selection-info" class="superset-selection-info"></span>
            </div>
            
            <div class="tbl-wrap tbl-wrap--full" role="region" aria-label="Workout plan exercises table">
                <table class="table table-striped workout-plan-table tbl tbl--responsive" 
                       role="table" 
                       aria-label="Workout plan exercises"
                       data-table-responsive="workout_plan"
                       data-testid="exercise-table">
                    <thead>
                        <tr>
                            <th scope="col" class="superset-select-col" width="40" aria-label="Select for superset" title="Select exercises to create superset">
                                <span class="superset-header-icon" aria-hidden="true"><i class="fas fa-link"></i></span>
                                <span class="visually-hidden">Select for Superset</span>
                            </th>
                            <th scope="col" width="30" aria-label="Drag handle"></th>
                            <th scope="col" class="col--high" data-label="Routine">Routine</th>
                            <th scope="col" class="col--high" data-label="Exercise">Exercise</th>
                            <th scope="col" class="col--med" data-label="Primary Muscle">Primary Muscle</th>
                            <th scope="col" class="col--low" data-label="Secondary Muscle">Secondary Muscle</th>
                            <th scope="col" class="col--low" data-label="Tertiary Muscle">Tertiary Muscle</th>
                            <th scope="col" class="col--low" data-label="Isolated Muscles">Isolated Muscles</th>
                            <th scope="col" class="col--low" data-label="Utility">Utility</th>
                            <th scope="col" class="col--low" data-label="Movement Pattern">Movement Pattern</th>
                            <th scope="col" class="col--low" data-label="Movement Subpattern">Movement Subpattern</th>
                            <th scope="col" class="col--high is-num" data-label="Sets">Sets</th>
                            <th scope="col" class="col--high is-num" data-label="Min Rep">Min Rep</th>
                            <th scope="col" class="col--high is-num" data-label="Max Rep">Max Rep</th>
                            <th scope="col" class="col--med is-num" data-label="RIR">RIR</th>
                            <th scope="col" class="col--med is-num" data-label="RPE">RPE</th>
                            <th scope="col" class="col--high is-num" data-label="Weight">Weight</th>
                            <th scope="col" class="col--med" data-label="Execution Style" title="Set AMRAP/EMOM timing">Style</th>
                            <th scope="col" class="col--low" data-label="Grips">Grips</th>
                            <th scope="col" class="col--low" data-label="Stabilizers">Stabilizers</th>
                            <th scope="col" class="col--low" data-label="Synergists">Synergists</th>
                            <th scope="col" class="col--high" data-label="Actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="workout_plan_table_body">
                        <!-- Rows will be populated dynamically via JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>
        <!-- AGENT:END B-1 PRIORITY-CLASSES -->
    </div>

    <!-- Generate Starter Plan Modal -->
    <div class="modal fade" id="generatePlanModal" tabindex="-1" aria-labelledby="generatePlanModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 90vw; width: 1600px;">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h5 class="modal-title" id="generatePlanModalLabel">
                        <i class="fas fa-magic me-2"></i>Generate Starter Plan
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-3">
                    <form id="generatePlanForm">
                        <!-- Row 1: All 6 dropdowns/controls -->
                        <div class="row g-2 mb-3">
                            <div class="col-xl-2 col-lg-4 col-md-6">
                                <label for="gen-training-days" class="form-label small mb-1">Training Days</label>
                                <select id="gen-training-days" class="form-select form-select-sm" required>
                                    <option value="1">1 day (Full-Body)</option>
                                    <option value="2">2 days (A/B)</option>
                                    <option value="3" selected>3 days (A/B/C)</option>
                                    <option value="4">4 days (U/L)</option>
                                    <option value="5">5 days (PPL+)</option>
                                </select>
                            </div>
                            <div class="col-xl-2 col-lg-4 col-md-6">
                                <label for="gen-environment" class="form-label small mb-1">Environment</label>
                                <select id="gen-environment" class="form-select form-select-sm" required>
                                    <option value="gym" selected>üèãÔ∏è Gym</option>
                                    <option value="home">üè† Home</option>
                                </select>
                            </div>
                            <div class="col-xl-2 col-lg-4 col-md-6">
                                <label for="gen-experience" class="form-label small mb-1">Experience</label>
                                <select id="gen-experience" class="form-select form-select-sm" required>
                                    <option value="novice" selected>Novice (&lt;1yr)</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                            <div class="col-xl-2 col-lg-4 col-md-6">
                                <label for="gen-goal" class="form-label small mb-1">Goal</label>
                                <select id="gen-goal" class="form-select form-select-sm" required>
                                    <option value="hypertrophy" selected>üí™ Hypertrophy</option>
                                    <option value="strength">üèÜ Strength</option>
                                    <option value="general">‚öñÔ∏è General</option>
                                </select>
                            </div>
                            <div class="col-xl-2 col-lg-4 col-md-6">
                                <label for="gen-volume-scale" class="form-label small mb-1">Volume: <span id="volume-scale-value" class="fw-bold">1.0x</span></label>
                                <input type="range" class="form-range" id="gen-volume-scale" min="0.6" max="1.2" step="0.1" value="1.0">
                            </div>
                            <div class="col-xl-2 col-lg-4 col-md-6">
                                <label class="form-label small mb-1">Options</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="checkbox" id="gen-overwrite" checked>
                                        <label class="form-check-label small" for="gen-overwrite">Overwrite</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="checkbox" id="gen-no-overhead">
                                        <label class="form-check-label small" for="gen-no-overhead">No Overhead Press</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="checkbox" id="gen-no-deadlift">
                                        <label class="form-check-label small" for="gen-no-deadlift">No Deadlifts</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Equipment -->
                        <div class="row g-2 mb-2">
                            <div class="col-12">
                                <label class="form-label small mb-1"><i class="fas fa-dumbbell me-1"></i>Equipment</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input equipment-check" type="checkbox" id="gen-eq-barbell" value="Barbell" checked>
                                        <label class="form-check-label small" for="gen-eq-barbell"><i class="fas fa-weight-hanging text-secondary"></i> Barbell</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input equipment-check" type="checkbox" id="gen-eq-dumbbells" value="Dumbbells" checked>
                                        <label class="form-check-label small" for="gen-eq-dumbbells"><i class="fas fa-dumbbell text-secondary"></i> Dumbbells</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input equipment-check" type="checkbox" id="gen-eq-cables" value="Cables" checked>
                                        <label class="form-check-label small" for="gen-eq-cables"><i class="fas fa-link text-secondary"></i> Cables</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input equipment-check" type="checkbox" id="gen-eq-machine" value="Machine" checked>
                                        <label class="form-check-label small" for="gen-eq-machine"><i class="fas fa-cogs text-secondary"></i> Machine</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input equipment-check" type="checkbox" id="gen-eq-bodyweight" value="Bodyweight" checked>
                                        <label class="form-check-label small" for="gen-eq-bodyweight"><i class="fas fa-running text-secondary"></i> Bodyweight</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input equipment-check" type="checkbox" id="gen-eq-kettlebells" value="Kettlebells">
                                        <label class="form-check-label small" for="gen-eq-kettlebells"><i class="fas fa-bowling-ball text-secondary"></i> Kettlebells</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input equipment-check" type="checkbox" id="gen-eq-smith" value="Smith_Machine">
                                        <label class="form-check-label small" for="gen-eq-smith"><i class="fas fa-grip-lines-vertical text-secondary"></i> Smith Machine</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input equipment-check" type="checkbox" id="gen-eq-trapbar" value="Trapbar">
                                        <label class="form-check-label small" for="gen-eq-trapbar"><i class="fas fa-hexagon text-secondary"></i> Trap Bar</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input equipment-check" type="checkbox" id="gen-eq-band" value="Band">
                                        <label class="form-check-label small" for="gen-eq-band"><i class="fas fa-ribbon text-secondary"></i> Band</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input equipment-check" type="checkbox" id="gen-eq-trx" value="Trx">
                                        <label class="form-check-label small" for="gen-eq-trx"><i class="fas fa-compress-arrows-alt text-secondary"></i> TRX</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input equipment-check" type="checkbox" id="gen-eq-plate" value="Plate">
                                        <label class="form-check-label small" for="gen-eq-plate"><i class="fas fa-circle text-secondary"></i> Plate</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input equipment-check" type="checkbox" id="gen-eq-medicine" value="Medicine_Ball">
                                        <label class="form-check-label small" for="gen-eq-medicine"><i class="fas fa-basketball-ball text-secondary"></i> Medicine Ball</label>
                                    </div>
                                    <span class="ms-2">
                                        <button type="button" class="btn btn-sm btn-link p-0 me-1" onclick="document.querySelectorAll('.equipment-check').forEach(c => c.checked = true)">All</button>
                                        <button type="button" class="btn btn-sm btn-link p-0" onclick="document.querySelectorAll('.equipment-check').forEach(c => c.checked = false)">None</button>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Row 3: Preview -->
                        <div class="row g-2 mb-3">
                            <div class="col-12">
                                <div class="p-2 bg-light rounded small" id="plan-preview">
                                    <strong><i class="fas fa-info-circle me-1"></i>Preview:</strong>
                                    <span id="plan-preview-content">A, B, C ‚Ä¢ ~7 exercises ‚Ä¢ 18 sets ‚Ä¢ 6-15 reps</span>
                                </div>
                            </div>
                        </div>

                        <!-- Row 4: Muscle selector full width -->
                        <div class="row">
                            <div class="col-12">
                                <label class="form-label small mb-1">
                                    <i class="fas fa-star me-1"></i>Priority Muscle Groups 
                                    <span class="text-muted">(Optional, max 2 - get extra volume)</span>
                                </label>
                                <div id="muscle-selector-container" class="muscle-selector-container">
                                    <!-- Muscle selector will be rendered here by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success btn-sm" id="generatePlanSubmit" onclick="generateStarterPlan()">
                        <i class="fas fa-magic me-1"></i>Generate Plan
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/modules/muscle-selector.js') }}"></script>

<script>
// Muscle Selector Instance (global for access)
let muscleSelector = null;

// Plan Generator Preview Update
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Muscle Selector
    muscleSelector = new MuscleSelector('muscle-selector-container');
    
    // Volume scale display update
    const volumeScale = document.getElementById('gen-volume-scale');
    const volumeScaleValue = document.getElementById('volume-scale-value');
    
    if (volumeScale && volumeScaleValue) {
        volumeScale.addEventListener('input', function() {
            volumeScaleValue.textContent = this.value + 'x';
            updatePlanPreview();
        });
    }
    
    // Environment change - auto-select equipment
    const envSelect = document.getElementById('gen-environment');
    if (envSelect) {
        envSelect.addEventListener('change', function() {
            updateEquipmentForEnvironment(this.value);
            updatePlanPreview();
        });
    }
    
    // Update preview when form changes
    const formInputs = document.querySelectorAll('#generatePlanForm select, #generatePlanForm input');
    formInputs.forEach(input => {
        input.addEventListener('change', updatePlanPreview);
    });
    
    function updateEquipmentForEnvironment(environment) {
        // Equipment available in each environment
        const gymEquipment = ['Barbell', 'Dumbbells', 'Cables', 'Machine', 'Bodyweight', 'Kettlebells', 
                             'Smith_Machine', 'Trapbar', 'Band', 'Trx', 'Plate', 'Medicine_Ball'];
        const homeEquipment = ['Dumbbells', 'Bodyweight', 'Band', 'Kettlebells', 'Trx', 'Medicine_Ball'];
        
        const selectedEquipment = environment === 'gym' ? gymEquipment : homeEquipment;
        
        // Update all equipment checkboxes
        document.querySelectorAll('.equipment-check').forEach(checkbox => {
            checkbox.checked = selectedEquipment.includes(checkbox.value);
        });
    }
    
    function updatePlanPreview() {
        const trainingDays = document.getElementById('gen-training-days')?.value || '3';
        const goal = document.getElementById('gen-goal')?.value || 'hypertrophy';
        const volumeScaleVal = document.getElementById('gen-volume-scale')?.value || '1.0';
        
        let routines = 'A';
        let splitName = 'Full-Body';
        if (trainingDays === '2') {
            routines = 'A, B';
            splitName = 'A/B';
        } else if (trainingDays === '3') {
            routines = 'A, B, C';
            splitName = 'A/B/C';
        } else if (trainingDays === '4') {
            routines = 'A, B, C, D';
            splitName = 'U/L';
        } else if (trainingDays === '5') {
            routines = 'A, B, C, D, E';
            splitName = 'PPL+';
        }
        
        let repRange = '6-10, 10-15';
        if (goal === 'strength') {
            repRange = '3-6, 6-10';
        } else if (goal === 'general') {
            repRange = '5-8, 8-12';
        }
        
        const baseSets = Math.round(18 * parseFloat(volumeScaleVal));
        
        const previewContent = document.getElementById('plan-preview-content');
        if (previewContent) {
            previewContent.textContent = `${routines} (${splitName}) ‚Ä¢ ~7 ex ‚Ä¢ ${baseSets} sets ‚Ä¢ ${repRange}`;
        }
    }
});
</script>

<script type="module">
document.addEventListener('DOMContentLoaded', function() {
    // Initialize collapse toggles
    const toggleButtons = document.querySelectorAll('.collapse-toggle');
    
    toggleButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const frame = this.closest('.collapsible-frame');
            const isExpanded = this.getAttribute('aria-expanded') === 'true';
            const toggleText = this.querySelector('.toggle-text');
            const allFrames = document.querySelectorAll('.collapsible-frame');
            
            // Toggle collapsed state
            frame.classList.toggle('collapsed');
            
            // Update aria-expanded
            this.setAttribute('aria-expanded', !isExpanded);
            
            // Update button text
            toggleText.textContent = isExpanded ? 'Show' : 'Hide';
            
            // Update title attribute for tooltip
            const sectionName = frame.getAttribute('data-section');
            const titleText = isExpanded ? `Expand ${sectionName}` : `Collapse ${sectionName}`;
            this.setAttribute('title', titleText);
            
            // CSS handles icon rotation via .collapsed class
            // No need for inline styles
            
            // Adjust spacing
            setTimeout(() => {
                // Recalculate positions after collapse/expand
                window.dispatchEvent(new Event('resize'));
                
                // Adjust margins for subsequent frames
                let previousFrame = frame;
                allFrames.forEach(currentFrame => {
                    if (currentFrame === frame) return;
                    
                    if (previousFrame.classList.contains('collapsed')) {
                        currentFrame.style.marginTop = '1rem';
                    } else {
                        currentFrame.style.marginTop = '2rem';
                    }
                    previousFrame = currentFrame;
                });
                
                // Adjust table margin
                const table = document.querySelector('.workout-plan.table-container');
                if (table) {
                    const lastFrame = Array.from(allFrames).pop();
                    table.style.marginTop = lastFrame.classList.contains('collapsed') ? '2rem' : '3rem';
                }
            }, 300); // Wait for collapse animation to complete
        });
    });
});
</script>

<!-- Save Program Modal -->
<div class="modal fade" id="saveBackupModal" tabindex="-1" aria-labelledby="saveBackupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveBackupModalLabel">
                    <i class="fas fa-save me-2"></i>Save Program
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="saveBackupForm">
                    <div class="mb-3">
                        <label for="backup-name" class="form-label">Program Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="backup-name" placeholder="e.g., My PPL Program" required maxlength="100">
                        <div class="form-text">Give your program a descriptive name.</div>
                    </div>
                    <div class="mb-3">
                        <label for="backup-note" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="backup-note" rows="2" placeholder="Optional notes about this program..." maxlength="500"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBackupSubmit">
                    <i class="fas fa-save me-1"></i>Save Program
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Program Library Modal -->
<div class="modal fade" id="programLibraryModal" tabindex="-1" aria-labelledby="programLibraryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="programLibraryModalLabel">
                    <i class="fas fa-folder-open me-2"></i>Program Library
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="p-3 bg-light border-bottom">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Restore a saved program to replace your current workout plan. Auto-backups are created automatically before data is erased.
                    </small>
                </div>
                <div id="backup-list" class="backup-list" style="max-height: 400px; overflow-y: auto;">
                    <!-- Backup items will be loaded dynamically -->
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2">Loading saved programs...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-primary btn-sm" id="openSaveFromLibrary">
                    <i class="fas fa-plus me-1"></i>Save Current Program
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Restore Modal -->
<div class="modal fade" id="confirmRestoreModal" tabindex="-1" aria-labelledby="confirmRestoreModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="confirmRestoreModalLabel">
                    <i class="fas fa-undo me-2"></i>Restore Program
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Restore "<strong id="restoreBackupName"></strong>"?</p>
                <p class="text-muted mb-0">This will replace your current workout plan with this backup.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRestoreBtn">
                    <i class="fas fa-undo me-1"></i>Restore
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmDeleteModalLabel">
                    <i class="fas fa-trash me-2"></i>Delete Program
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Delete "<strong id="deleteBackupName"></strong>"?</p>
                <p class="text-danger mb-0"><i class="fas fa-exclamation-triangle me-1"></i>This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Clear Plan Confirmation Modal -->
<div class="modal fade" id="clearPlanModal" tabindex="-1" aria-labelledby="clearPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="clearPlanModalLabel">
                    <i class="fas fa-trash-alt me-2"></i>Clear Workout Plan
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to clear the entire workout plan?</p>
                <p class="text-danger mb-0"><i class="fas fa-exclamation-triangle me-1"></i>This will remove all exercises and cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmClearPlanBtn" onclick="clearWorkoutPlan()">
                    <i class="fas fa-trash-alt me-1"></i>Clear Plan
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
